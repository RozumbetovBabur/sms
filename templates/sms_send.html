{% extends 'base.html' %}
{% load static %}
{% block telegram_send %}
<div class="row justify-content-around mt-4 text-center">
                <div class="col-sm-12">
                    <h2>ğŸ“¨ SMS Jiberiw</h2>
                </div>

<!-- Progress bar -->
                        <div class="bg-light rounded h-100 p-4">
                            <h6 class="mb-4">Progress Bar</h6>
                            <div class="pg-bar mb-3">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped bg-success" role="progressbar"
                                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        0%
                                    </div>
                                </div>
                            </div>
                        </div>
<!-- jQuery kutubxonasi -->


<!-- SMS Joâ€˜natish tugmasi -->
<form id="send_sms_form" method="POST">
    {% csrf_token %}
    <button id="send_sms_button" class="btn btn-primary mt-5">ğŸ“¤ SMS Joâ€˜natish</button>
</form>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function getCSRFToken() {
    let token = document.querySelector("input[name=csrfmiddlewaretoken]");
    return token ? token.value : "";
}

$(document).ready(function () {
    $("#send_sms_button").click(function (e) {
        e.preventDefault();
        $("#send_sms_button").hide();
        $(".progress-bar").css("width", "0%").text("0%");
        $("#sms_result").html("");  // ğŸ“Œ Eski natijalarni oâ€˜chiramiz

        $.ajax({
            type: "POST",
            url: "/send_sms_from_debitors/",
            data: { csrfmiddlewaretoken: getCSRFToken() },
            success: function (data) {
                if (data.success) {
                    checkProgress();
                } else {
                    alert("âŒ Xatolik: " + data.error);
                    $("#send_sms_button").show();
                }
            },
            error: function (xhr, status, error) {
                alert("âŒ Server xatosi: " + error);
                $("#send_sms_button").show();
            }
        });
    });

    function checkProgress() {
        $.get("/get_sms_progress/")
            .done(function (data) {
                let total = data.total || 0;
                let sent = data.sent || 0;
                let percentage = total > 0 ? Math.round((sent / total) * 100) : 0;

                $(".progress-bar").css("width", percentage + "%").text(percentage + "%");

                if (!data.completed) {
                    setTimeout(checkProgress, 2000);
                } else {
                    $(".progress-bar").css("width", "100%").text("100% âœ…");
                    $("#send_sms_button").show();

                    // ğŸ“Œ SMS natijalarini chiqaramiz
                    let resultHtml = `<h4>ğŸ“Š SMS Joâ€˜natish Natijalari:</h4>`;
                    resultHtml += `<p>âœ… Muvaffaqiyatli joâ€˜natilgan SMSlar: <b>${data.successful_sms || 0}</b></p>`;

                    // âœ… Joâ€˜natilgan SMSlar roâ€˜yxati
                    if (Array.isArray(data.sent_sms) && data.sent_sms.length > 0) {
                        resultHtml += `<h5>ğŸ“¤ Joâ€˜natilgan SMSlar:</h5><ul>`;
                        data.sent_sms.forEach(sms => {
                            resultHtml += `<li><b>ğŸ“ Telefon:</b> ${sms.phone_number} | <b>âœ‰ï¸ Matn:</b> ${sms.sms_text}</li>`;
                        });
                        resultHtml += `</ul>`;
                    }

                    if (Array.isArray(data.failed_sms) && data.failed_sms.length > 0) {
                    resultHtml += `<p>âŒ Xatolik bilan joâ€˜natilgan SMSlar: <b>${data.failed_sms.length}</b></p>`;
                    resultHtml += `<h5>âŒ Xatolik yuz bergan SMSlar:</h5><ul>`;
                    data.failed_sms.forEach(sms => {
                        resultHtml += `<li><b>ğŸ“ Telefon:</b> ${sms.phone_number} | <b>âœ‰ï¸ Matn:</b> ${sms.sms_text} | <b>ğŸ“› Status:</b> ${sms.status}</li>`;
                    });
                    resultHtml += `</ul>`;
                }

                // âŒ Notoâ€˜gâ€˜ri formatdagi SMSlar
                if (Array.isArray(data.invalid_sms) && data.invalid_sms.length > 0) {
                    resultHtml += `<p>âš ï¸ Notoâ€˜gâ€˜ri formatdagi SMSlar: <b>${data.invalid_sms.length}</b></p>`;
                    resultHtml += `<h5>âš ï¸ Xato formatdagi SMSlar:</h5><ul>`;
                    data.invalid_sms.forEach(sms => {
                        resultHtml += `<li><b>ğŸ“ Telefon:</b> ${sms.phone_number} | <b>âœ‰ï¸ Matn:</b> ${sms.sms_text} | <b>ğŸ“› Status:</b> ${sms.status}</li>`;
                    });
                    resultHtml += `</ul>`;
                } else {
                    resultHtml += `<p>âœ… Barcha SMSlar toâ€˜gâ€˜ri formatda edi!</p>`;
                }

                $("#sms_result").html(resultHtml);
            }
           })
           .fail(function (xhr, status, error) {
               alert("âŒ Ma'lumot olishda xatolik: " + error);
               $("#send_sms_button").show();
           });
    }
});

</script>

    <div id="sms_result" class="mt-3">ğŸ“Š SMS natijalari shu yerda chiqadi...</div>



</div>
{% endblock telegram_send %}

